#!/usr/bin/env bash

. $HOME/.config/shell/rc.sh

seperator=' | '
widgets=()

w_battery() {
	# Change BAT1 to whatever your battery is identified as. Typically BAT0 or BAT1
	charge=$(cat /sys/class/power_supply/BAT0/capacity 2>/dev/null)
	status=$(cat /sys/class/power_supply/BAT0/status 2>/dev/null)

	if [ -z $status ]; then
		return
	fi

	if [ "$status" = "Charging" ]; then
		printf "ðŸ”Œ %s%% %s" "$charge"
	else
		printf "ðŸ”‹ %s%% %s" "$charge"
	fi
}

handsfree_bluetooth_cache="/tmp/handsfree_bluetooth_cache"

w_bluetooth_battery() {
	local last_modified_time=$(stat -c '%Y' "$handsfree_bluetooth_cache" || printf '0')
	local now=$(date '+%s')
	local _5_minutes=$(expr 5 '*' 60)
	local ttl_threshold=$(expr $now - $_5_minutes)

	if [ $last_modified_time -gt $ttl_threshold ]; then
		cat "$handsfree_bluetooth_cache"
		return
	fi

	local devices="$(bluetoothctl devices Connected | awk '{ print $2 }')"

	local ret="$(for device in "$devices"; do
		if [ -z "$device" ]; then
			break
		fi
		level="$(bluetooth-headset-battery-level "$device" | grep -oE '[0-9]+%')"

		echo "ðŸŽ§ $level"
	done | sed '/^$/d' | tr '\n' ' |')"

	printf "%s" "$ret" >"$handsfree_bluetooth_cache"
	cat "$handsfree_bluetooth_cache"
}

w_date() {
	printf "ðŸ“† %s" "$(date "+%a %d-%m-%y %T")"
}

get_bar() {
	index=0
	for widget in ${widgets[@]}; do
		if [ $index -ne 0 ]; then
			printf "%s" "$seperator"
		fi

		w_$widget

		index=$((index + 1))
	done
}

set_widgets() {
	if is_laptop; then
		widgets=('bluetooth_battery' 'battery' 'date')
	else
		widgets=('bluetooth_battery' 'date')
	fi
}

main() {
	set_widgets

	while true; do
		res=$(get_bar)
		echo "$res"
		sleep 1
	done
}

main
