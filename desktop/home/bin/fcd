#!/bin/bash

level="$(tr -dc '/' <<<"$PWD" | wc -c)"

path=""
parents="$(for i in $(seq $((level))); do
	path="../$path"
	echo "$(realpath $path)"
done)"

fifo="$(mktemp -u)"
mkfifo $fifo

fill_fifo() {
	echo "$parents" >>$fifo
	find -type d 2>/dev/null | grep -v -E '(^\.$|node_modules|/\.[^/]+)' >>$fifo
}

fill_fifo &

background_job=$!
disown $background_job

selected=$(fzf <$fifo)

cd "$selected"

[ -f /proc/$background_job ] && kill $background_job

rm $fifo
