#!/usr/bin/env bash

ncu -u

name="$(cat package.json | jq '.name' -r)"
echo "$name"
version="$(cat package.json | jq '.version' -r)"
major="$(echo "$version" | cut -d'.' -f 1)"
minor="$(echo "$version" | cut -d'.' -f 2)"
patch="$(echo "$version" | cut -d'.' -f 3)"
new_version="$major.$minor.$((patch + 1))"

if [ -z "$(git diff package*)" ]; then
	echo 'no package upgraded'
	exit 1
fi

mv package.json{,_} && cat package.json_ | jq ".version = \"$new_version\" | .dependencies.\"reflect-metadata\"=\"^0.1.x\"" >package.json && rm package.json_
cat package.json | jq ''

if [ -n "$(git log HEAD..origin/HEAD)" ]; then
	echo 'has not pushed yet'
	exit 1
fi

npm i --cache /tmp/foo || exit 1

npm audit fix

tsc && git add package* && git commit -m "update dependencies" -m "https://git.sanfam.ir/sanfam/projects/saman/others/-/issues/84" && git push
