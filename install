#!/usr/bin/env bash

execute_with_privilege() {
	local base_dir="$1"
	[ "$base_dir" = 'root' ] && sudo ${@:2} || ${@:2}
	return $?
}

get_destination_dir() {
	local base_dir="$1"

	[ $base_dir = 'root' ] && echo -n "/" || echo -n "$HOME"
}

assert_destination_directories() {
	local base_dir="$1"
	local dest_dir=$(get_destination_dir "$base_dir")

	find "$base_dir" -type d | while read dir; do
		local path="$dest_dir/$(echo "$dir" | sed "s/$base_dir//")"

		execute_with_privilege "$base_dir" mkdir -p "$path"
	done
}

setup_symlinks() {
	local base_dir="$1"

	assert_destination_directories "$base_dir"
	execute_with_privilege "$base_dir" stow -vt "$(get_destination_dir "$base_dir")" "$base_dir"
}

setup_nnn() {
	local plugins=(fzcd dragdrop cdpath)
	local plugins_installed=1

	for plugin in "${plugins[@]}"; do
		local path="$HOME/.config/nnn/plugins/$plugin"

		[ -f "$path" ] || {
			plugins_installed=0
			break
		}
	done

	[ $plugins_installed -eq 1 ] && return

	sh -c "$(curl -Ls https://raw.githubusercontent.com/jarun/nnn/master/plugins/getplugs)"
	echo 'nnn plugins installed'
}

main() {
	setup_symlinks user
	setup_symlinks root
	setup_nnn

	sudo locale-gen
}

main
